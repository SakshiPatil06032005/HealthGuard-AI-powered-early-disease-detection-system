<!-- Enhanced X-Ray Prediction Results Display Template
     Display medical imaging analysis results directly on the dashboard board
     Shows comprehensive prediction details, confidence scores, severity levels, and recommendations
-->
{% extends 'dashboards/base_dashboard.html' %}

{% block content %}
<div class="container-fluid py-6">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
            <i class="fas fa-image text-blue-600 mr-3"></i>X-Ray Analysis & Prediction
        </h1>
        <p class="text-gray-600">AI-powered comprehensive disease detection using ensemble deep learning</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Upload Form -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-6 sticky top-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-upload mr-2 text-green-600"></i>Upload X-Ray Image
                </h3>

                <form method="POST" enctype="multipart/form-data">
                    <!-- Drag & Drop Area -->
                    <div id="uploadArea" class="border-2 border-dashed border-blue-300 rounded-lg p-6 mb-4 cursor-pointer hover:bg-blue-50 transition">
                        <input type="file" id="xrayInput" name="xray_image" class="hidden" accept=".png,.jpg,.jpeg,.pdf" onchange="updateFileName(this)">
                        <div class="text-center">
                            <i class="fas fa-cloud-upload-alt text-4xl text-blue-400 mb-3"></i>
                            <p class="text-gray-700 font-semibold mb-2">Drag & drop X-ray image here</p>
                            <p class="text-sm text-gray-500 mb-4">or</p>
                            <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition" 
                                    onclick="document.getElementById('xrayInput').click()">
                                Browse Files
                            </button>
                        </div>
                    </div>

                    <!-- File Name Display -->
                    <div id="fileNameDisplay" class="hidden mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <p class="text-sm text-green-700">
                            <i class="fas fa-check-circle mr-2"></i>
                            <span id="fileName"></span>
                        </p>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition">
                        <i class="fas fa-play mr-2"></i>Analyze X-Ray
                    </button>

                    <!-- Info Box -->
                    <div class="mt-6 p-4 bg-blue-50 border-l-4 border-blue-600 rounded-lg">
                        <h4 class="font-semibold text-blue-900 mb-2">
                            <i class="fas fa-info-circle mr-2"></i>How It Works
                        </h4>
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>✓ Analyzes chest X-ray images for disease patterns</li>
                            <li>✓ Detects 40+ diseases with ensemble deep learning</li>
                            <li>✓ Provides confidence scores and severity assessment</li>
                            <li>✓ Shows treatment recommendations</li>
                            <li>⚠️ Results are for informational purposes only</li>
                        </ul>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="lg:col-span-2">
            {% if predictions %}
            <div class="space-y-6">
                <!-- Analysis Summary Card -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-md p-6 border-l-4 border-blue-600">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-pie mr-2 text-blue-600"></i>Analysis Summary
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <p class="text-3xl font-bold text-blue-600">{{ predictions|length }}</p>
                            <p class="text-sm text-gray-600">Findings</p>
                        </div>
                        <div class="text-center">
                            <p class="text-3xl font-bold text-green-600">{{ analysis_details.overall_confidence|round(1) }}%</p>
                            <p class="text-sm text-gray-600">Overall Confidence</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold">{{ predictions[0].severity|upper }}</p>
                            <p class="text-sm text-gray-600">Top Risk Level</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-indigo-600">Ensemble</p>
                            <p class="text-sm text-gray-600">3-Model Voting</p>
                        </div>
                    </div>
                </div>

                <!-- Disease Predictions -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-stethoscope mr-2 text-green-600"></i>Detected Diseases
                    </h3>

                    <div class="space-y-4">
                        {% for prediction in predictions %}
                            {% set severity_colors = {
                                'low': {'bg': 'bg-green-50', 'border': 'border-green-500', 'text': 'text-green-700', 'badge': 'bg-green-100 text-green-800'},
                                'moderate': {'bg': 'bg-yellow-50', 'border': 'border-yellow-500', 'text': 'text-yellow-700', 'badge': 'bg-yellow-100 text-yellow-800'},
                                'high': {'bg': 'bg-red-50', 'border': 'border-red-500', 'text': 'text-red-700', 'badge': 'bg-red-100 text-red-800'},
                                'critical': {'bg': 'bg-red-100', 'border': 'border-red-600', 'text': 'text-red-900', 'badge': 'bg-red-200 text-red-900'}
                            } %}
                            {% set severity = prediction.severity|lower %}
                            {% set colors = severity_colors.get(severity, severity_colors.moderate) %}

                            <div class="p-4 rounded-lg border-l-4 {{ colors.bg }} {{ colors.border }}">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <p class="text-lg font-bold {{ colors.text }}">{{ prediction.disease }}</p>
                                        <p class="text-sm {{ colors.text|replace('text-', 'text-opacity-70 ') }}">{{ prediction.description or 'No description available' }}</p>
                                    </div>
                                    <span class="px-3 py-1 rounded-full text-sm font-semibold {{ colors.badge }}">
                                        {{ prediction.severity|upper }}
                                    </span>
                                </div>

                                <!-- Confidence Bar -->
                                <div class="mb-3">
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="font-semibold">Confidence Level:</span>
                                        <span class="font-bold">{{ prediction.confidence|round(1) }}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2" data-confidence="{{ prediction.confidence|round(1) }}" 
                                         data-severity="{{ severity }}">
                                        <div class="h-full rounded-full confidence-bar" 
                                             data-width="{{ prediction.confidence|round(1) }}">
                                        </div>
                                    </div>
                                </div>

                                <!-- Treatment Info -->
                                <div class="mt-3 p-3 bg-white bg-opacity-50 rounded">
                                    <p class="text-sm font-semibold text-gray-700 mb-1">Recommended Treatment:</p>
                                    <p class="text-sm text-gray-600">{{ prediction.treatment or 'Consult healthcare professional' }}</p>
                                </div>

                                <!-- Referral Info -->
                                <div class="mt-2 text-xs">
                                    <span class="font-semibold text-gray-700">Suggested Referral:</span>
                                    <span class="ml-2 px-2 py-1 bg-white rounded text-gray-600">{{ prediction.referral or 'General Practitioner' }}</span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Medicine Suggestions -->
                {% if medicine_suggestions %}
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-pills mr-2 text-blue-600"></i>Treatment Recommendations
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Primary Medicines -->
                        {% if medicine_suggestions.get('primary_medicines') %}
                        <div>
                            <h4 class="font-bold text-gray-800 mb-3">Primary Medicines</h4>
                            <div class="space-y-2">
                                {% for med in medicine_suggestions.primary_medicines[:3] %}
                                <div class="p-3 bg-blue-50 rounded border border-blue-200">
                                    <p class="font-semibold text-blue-900">{{ med.name }}</p>
                                    <p class="text-sm text-blue-700">{{ med.dosage }}</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Precautions -->
                        {% if medicine_suggestions.get('precautions') %}
                        <div>
                            <h4 class="font-bold text-gray-800 mb-3">Important Precautions</h4>
                            <div class="space-y-2">
                                {% for precaution in medicine_suggestions.precautions[:3] %}
                                <div class="p-3 bg-yellow-50 rounded border border-yellow-200">
                                    <p class="text-sm text-yellow-800">⚠️ {{ precaution }}</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Clinical Insights -->
                {% if analysis_details %}
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-lightbulb mr-2 text-yellow-600"></i>Clinical Insights
                    </h3>
                    <div class="space-y-3">
                        <div class="p-3 bg-indigo-50 rounded border-l-4 border-indigo-500">
                            <p class="text-sm text-indigo-800">
                                <strong>Analysis Method:</strong> {{ analysis_details.get('analysis_method', 'Ensemble Deep Learning') }}
                            </p>
                        </div>
                        <div class="p-3 bg-purple-50 rounded border-l-4 border-purple-500">
                            <p class="text-sm text-purple-800">
                                <strong>Models Used:</strong> ResNet50, VGG16, InceptionV3 with ensemble voting
                            </p>
                        </div>
                        <div class="p-3 bg-pink-50 rounded border-l-4 border-pink-500">
                            <p class="text-sm text-pink-800">
                                <strong>Recommendation:</strong> Always consult a healthcare professional for diagnosis and treatment decisions.
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}

            </div>

            {% else %}
            <!-- No Results Yet -->
            <div class="bg-white rounded-lg shadow-md p-12 text-center">
                <i class="fas fa-image text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-2xl font-bold text-gray-600 mb-2">No Analysis Results Yet</h3>
                <p class="text-gray-500 mb-6">Upload an X-ray image to see comprehensive analysis results with disease detection, confidence scores, severity assessment, and treatment recommendations.</p>
                <p class="text-sm text-gray-400">Powered by ensemble deep learning with 40+ disease detection capability</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
    // Initialize confidence bars
    document.querySelectorAll('.confidence-bar').forEach(function(bar) {
        const width = bar.getAttribute('data-width');
        const parent = bar.parentElement;
        const severity = parent.getAttribute('data-severity');
        
        const colorClass = severity === 'low' ? 'bg-green-500' : 
                          severity === 'moderate' ? 'bg-yellow-500' : 'bg-red-500';
        
        bar.classList.add(colorClass);
        bar.style.width = width + '%';
    });

    const uploadArea = document.getElementById('uploadArea');
    const xrayInput = document.getElementById('xrayInput');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const fileName = document.getElementById('fileName');

    function handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.add('border-blue-500', 'bg-blue-50');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove('border-blue-500', 'bg-blue-50');
    }

    function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove('border-blue-500', 'bg-blue-50');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            xrayInput.files = files;
            updateFileName(xrayInput);
        }
    }

    function updateFileName(input) {
        if (input.files && input.files.length > 0) {
            fileName.textContent = input.files[0].name;
            fileNameDisplay.classList.remove('hidden');
        } else {
            fileNameDisplay.classList.add('hidden');
        }
    }

    // Drag and drop event listeners
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    uploadArea.addEventListener('drop', handleDrop);
    uploadArea.addEventListener('click', () => xrayInput.click());
</script>
{% endblock %}
